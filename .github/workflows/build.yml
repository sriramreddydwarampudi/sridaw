name: Build Kivy APK

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Android SDK & Accept Licenses
      run: |
        sudo apt update
        sudo apt install -y zip unzip openjdk-17-jdk libncurses6 zlib1g curl

        mkdir -p $HOME/android-sdk/cmdline-tools
        cd $HOME/android-sdk/cmdline-tools

        # Download command line tools
        curl -s -o sdk.zip https://dl.google.com/android/repository/commandlinetools-linux-10406996_latest.zip
        unzip -q sdk.zip
        rm sdk.zip
        mv cmdline-tools latest

        # Set environment variables
        echo "ANDROID_HOME=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=$HOME/android-sdk" >> $GITHUB_ENV
        echo "$HOME/android-sdk/cmdline-tools/latest/bin" >> $GITHUB_PATH
        echo "$HOME/android-sdk/platform-tools" >> $GITHUB_PATH

    - name: Accept SDK licenses and install packages
      run: |
        mkdir -p $HOME/.android
        touch $HOME/.android/repositories.cfg
        # Accept all licenses
        yes | sdkmanager --licenses
        # Install platform tools and build-tools
        sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0" "ndk;25.1.8937393"
        sdkmanager --install "cmdline-tools;latest"
        # Verify installation
        ls $HOME/android-sdk/build-tools/34.0.0/aidl && echo "AIDL found" || echo "AIDL missing"

    - name: Install Python and Buildozer dependencies
      run: |
        sudo apt install -y python3-pip python3-setuptools python3-wheel git autoconf libtool pkg-config zlib1g-dev libncurses5-dev libncursesw5-dev cmake
        sudo apt install -y libtinfo6
        pip install --upgrade pip
        pip install --use-pep517 buildozer cython virtualenv sh

    - name: Install Apache ANT manually
      run: |
        curl -L -o apache-ant.tar.gz https://archive.apache.org/dist/ant/binaries/apache-ant-1.10.12-bin.tar.gz
        if file apache-ant.tar.gz | grep -q "gzip compressed data"; then
          mkdir -p $HOME/android-sdk/ant
          tar xzf apache-ant.tar.gz -C $HOME/android-sdk/ant --strip-components=1
          rm apache-ant.tar.gz
          echo "$HOME/android-sdk/ant/bin" >> $GITHUB_PATH
        else
          echo "Failed to download valid ANT archive"
          exit 1
        fi

    - name: Configure Buildozer
      run: |
        echo "ANDROIDSDK=$HOME/android-sdk" >> $GITHUB_ENV
        echo "ANDROIDNDK=$HOME/android-sdk/ndk/25.1.8937393" >> $GITHUB_ENV
        # Update buildozer.spec
        sed -i "s|^#\?android\.sdk_path =.*|android.sdk_path = $ANDROIDSDK|" buildozer.spec
        sed -i "s|^#\?android\.ndk_path =.*|android.ndk_path = $ANDROIDNDK|" buildozer.spec
        echo "android.ant_path = $HOME/android-sdk/ant" >> buildozer.spec
        # Ensure build-tools are properly referenced
        echo "android.build_tools_version = 34.0.0" >> buildozer.spec

    - name: Build APK with Buildozer
      run: |
        buildozer -v android debug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: sridaw-apk
        path: bin/*.apk
